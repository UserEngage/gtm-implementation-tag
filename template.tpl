___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "User.com | Implementation",
  "categories": ["LEAD_GENERATION", "CHAT", "MARKETING"],
  "brand": {
    "id": "user_com",
    "displayName": "User.com",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Install User.com on your Website and track user behaviours, habits and data with ease.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "requiredGroup",
    "displayName": "Configuration (required)",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "apiKey",
        "displayName": "Api Key",
        "simpleValueType": true,
        "help": "Your User.com app Api Key. Can be found in User.com Settings -\u003e Setup \u0026 Integrations.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "alwaysInSummary": true,
        "valueHint": "hdp39N"
      },
      {
        "type": "TEXT",
        "name": "appDomain",
        "displayName": "App Domain",
        "simpleValueType": true,
        "help": "Your User.com App Domain. Can be found in User.com Settings -\u003e Setup \u0026 Integrations.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "alwaysInSummary": true,
        "valueHint": "example.user.com"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "optionalDataGroup",
    "displayName": "User Attributes (optional)",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userAttrs",
        "displayName": "Attributes",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "valueHint": "first_name"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add attribute"
      },
      {
        "type": "LABEL",
        "name": "infoLabel",
        "displayName": "Within attributes section you can pass data to update your User Attributes.\n\u003cbr\u003e\nAttribute names must have all \u003cstrong\u003eblank spaces\u003c/strong\u003e replaced with \u003cstrong\u003e_\u003c/strong\u003e"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "visibilityGroup",
    "displayName": "Widget Icon Visibility (optional)",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "widgetVisibility",
        "displayName": "",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "simple",
            "displayValue": "Simple Widget"
          },
          {
            "value": "standard",
            "displayValue": "Standard Widget"
          },
          {
            "value": "expanded",
            "displayValue": "Open Widget"
          },
          {
            "value": "hidden",
            "displayValue": "Hidden Widget"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "",
        "notSetText": "--"
      },
      {
        "type": "LABEL",
        "name": "visibilityLabel",
        "displayName": "This settings \u003cstrong\u003ewill overwrite\u003c/strong\u003e User.com application settings regarding Widget Icon Visibility. \n\u003cbr\u003e\nKeep it as \u003cstrong\u003eNot Set --\u003c/strong\u003e to let User.com application decide when Widget Icon should be visible."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "optionalConfigGroup",
    "displayName": "Additional Configuration (optional)",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "logEnabled",
        "checkboxText": "Console Logs",
        "simpleValueType": true,
        "help": "Select to enable debug console logs. Selection will enable logs in both \u003cstrong\u003ePreview and Published\u003c/strong\u003e containers.",
        "alwaysInSummary": false,
        "clearOnCopy": false
      },
      {
        "type": "CHECKBOX",
        "name": "widgetReadyEnabled",
        "checkboxText": "Widget Ready Callback",
        "simpleValueType": true,
        "help": "Select to send a dataLayer Event when User.com loads. You should use this Event to trigger other User.com tags instead of native Page Visit Events."
      },
      {
        "type": "TEXT",
        "name": "callbackName",
        "displayName": "Callback Name",
        "simpleValueType": true,
        "valueHint": "Widget Ready",
        "enablingConditions": [
          {
            "paramName": "widgetReadyEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "LABEL",
        "name": "callbackConfigLabel",
        "displayName": "You can override default Widget Ready Callback Name. Default Event name is \u003cb\u003eWidget Ready\u003c/b\u003e.",
        "enablingConditions": [
          {
            "paramName": "widgetReadyEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Setup Google APIs
const log = require('logToConsole');
const encodeUriComponent = require('encodeUriComponent');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const setInWindow = require('setInWindow');
const makeTableMap = require('makeTableMap');
const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');
const Object = require('Object');

const WIDGET_OBJECT_NAME = 'civchat';
const DEFAULT_CALLBACK_NAME = 'Widget Ready';
const SUCCESS_MESSAGE_DOMAIN = 'User.com |Success| Script Load Started';
const FAILURE_MESSAGE_KEY = 'User.com |Error| Verify that Api Key is correct.';
const FAILURE_MESSAGE_DOMAIN = 'User.com |Error| Verify that App Domain is correct.';
const FAILURE_MESSAGE_PERMISSIONS = 'User.com |Error| Verify inputs and required permissions.';
const EMPTY_OBJECT = {};

// Get User preferences
const logger = data.logEnabled ? log : () => EMPTY_OBJECT;
const eventPush = data.widgetReadyEnabled ? dataLayerPush : () => EMPTY_OBJECT;
const arePermissionsGranted = (name, url) => queryPermission('access_globals', 'readwrite', name) &&                   queryPermission('inject_script', url);

const getUserData = (data) => makeTableMap(data, 'name', 'value');
const getCallback = (name) => ({ event: name });
const getWidgetVisibility = (type) => ({ state: type });
const getAppDomain = (domain) => 'https://' + domain + '/widget.js';
const getWidgetData = (key, data) => ({ 
  apiKey: key, 
  onLoad: function () { 
    eventPush(data); 
  }
});


// Get config values
const apiKey = data.apiKey || onFailure(FAILURE_MESSAGE_KEY);
const appDomain = data.appDomain ? encodeUriComponent(data.appDomain) : onFailure(FAILURE_MESSAGE_DOMAIN);
const domainUrl = getAppDomain(appDomain);
const callbackName = data.callbackName ? getCallback(data.callbackName) : getCallback(DEFAULT_CALLBACK_NAME);
const userData = data.userAttrs ? getUserData(data.userAttrs) : EMPTY_OBJECT;
const widgetState = data.widgetVisibility ? getWidgetVisibility(data.widgetVisibility) : EMPTY_OBJECT;
const widgetData = getWidgetData(apiKey, callbackName);
const mergedWidgetData = mergeObjects(userData, widgetState, widgetData);

function onSuccess (message) {
    logger(message);
    data.gtmOnSuccess();
}

function onFailure (message) {
    logger(message);
    data.gtmOnFailure();
}

function mergeObjects () {
  const resObj = EMPTY_OBJECT;
  for (const arg of arguments) {
    const keys = Object.keys(arg);
    for (const key of keys) {
      resObj[key] = arg[key];
      }
    }
  return resObj;
}

function setCivchat (data) {
    setInWindow(WIDGET_OBJECT_NAME, data, true);
    logger('Civchat data:', data);
}

function setWidget (url) {
    injectScript(url, onSuccess(SUCCESS_MESSAGE_DOMAIN));
    logger('Domain URL:', url);
}

function loadUserCom (data, url) {
    setCivchat(data);
    setWidget(url);
}


// Execute
if (arePermissionsGranted(WIDGET_OBJECT_NAME, domainUrl)) {
    loadUserCom(mergedWidgetData, domainUrl);
} else {
    onFailure(FAILURE_MESSAGE_PERMISSIONS);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.user.com/widget.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "civchat"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "userengage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Valid basic data returns Success
  code: |-
    runCode(validCivchatMock);

    assertApi('makeTableMap').wasNotCalled();
    assertApi('injectScript').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Valid complete data returns Success
  code: |-
    runCode(validFullDataMock);

    assertApi('makeTableMap').wasCalled();
    assertApi('injectScript').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const validCivchatMock = {
    apiKey: 'HdpN3',
    appDomain: 'example.user.com'
  };

  const validFullDataMock = {
    apiKey: 'HdpN3',
    appDomain: 'example.user.com',
    userAttrs: [{
      name: 'user_id',
      value: '343322'
    },
    {
      name: 'first_name',
      value: 'Example'
    }],
    widgetVisibility: 'hidden'
  };


___NOTES___

Created on 1.04.2022, 11:28:54


